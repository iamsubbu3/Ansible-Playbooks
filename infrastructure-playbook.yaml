---
# ==============================================================================
# LAYER 1: INFRASTRUCTURE & COMMON TOOLS
# ==============================================================================

- name: Layer 1 - Common Infrastructure Setup
  hosts: all
  become: true

  vars:
    docker_keyring: /etc/apt/keyrings/docker.gpg

  tasks:

    # ------------------------------------------------
    # Base Packages
    # ------------------------------------------------
    - name: Install system prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - unzip
          - wget
          - software-properties-common
          - python3-pip
          - python3-docker
        state: present
        update_cache: yes

    - name: Ensure keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    # ------------------------------------------------
    # Docker Installation
    # ------------------------------------------------
    - name: Install Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o {{ docker_keyring }}
      args:
        creates: "{{ docker_keyring }}"

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by={{ docker_keyring }}] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        filename: docker
        state: present
        update_cache: yes

    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Enable Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add remote user to docker group on all hosts
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Reset SSH connection to apply docker group
      meta: reset_connection

    # ------------------------------------------------
    # AWS CLI + kubectl
    # ------------------------------------------------
    - name: Install AWS CLI v2
      shell: |
        if ! command -v aws >/dev/null; then
          curl -s https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o /tmp/awscliv2.zip
          unzip -q /tmp/awscliv2.zip -d /tmp
          /tmp/aws/install --update
        fi
      args:
        creates: /usr/local/bin/aws

    - name: Get latest kubectl version
      shell: curl -L -s https://dl.k8s.io/release/stable.txt
      register: kubectl_version
      changed_when: false

    - name: Install kubectl
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version.stdout }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: "0755"

# ==============================================================================
# LAYER 2: CI/CD & SECURITY
# ==============================================================================

- name: Layer 2 - Jenkins, SonarQube & Security
  hosts: jenkins1
  become: true

  vars:
    jenkins_keyring: /etc/apt/keyrings/jenkins-keyring.gpg
    trivy_keyring: /etc/apt/keyrings/trivy.gpg

  handlers:
    - name: restart jenkins
      service:
        name: jenkins
        state: restarted

  tasks:

    # ------------------------------------------------
    # Kernel tuning
    # ------------------------------------------------
    - name: Tune vm.max_map_count for SonarQube
      sysctl:
        name: vm.max_map_count
        value: "262144"
        state: present
        reload: yes

    # ------------------------------------------------
    # Jenkins Installation
    # ------------------------------------------------
    - name: Install Jenkins GPG key
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2026.key | gpg --dearmor -o {{ jenkins_keyring }}
      args:
        creates: "{{ jenkins_keyring }}"

    - name: Add Jenkins repository
      apt_repository:
        repo: "deb [signed-by={{ jenkins_keyring }}] https://pkg.jenkins.io/debian-stable binary/"
        filename: jenkins
        state: present
        update_cache: yes

    - name: Install Java 21 and Jenkins
      apt:
        name:
          - openjdk-21-jdk
          - jenkins
        state: present
        update_cache: yes

    - name: Detect JAVA_HOME path
      shell: readlink -f $(which java) | sed "s:/bin/java::"
      register: java_home
      changed_when: false

    - name: Set JAVA_HOME globally
      lineinfile:
        path: /etc/environment
        regexp: '^JAVA_HOME='
        line: "JAVA_HOME={{ java_home.stdout }}"
        create: yes

    - name: Configure JAVA_HOME in Jenkins defaults
      lineinfile:
        path: /etc/default/jenkins
        regexp: '^JAVA_HOME='
        line: "JAVA_HOME={{ java_home.stdout }}"
        create: yes
      notify: restart jenkins

    - name: Reset failed Jenkins state (if any)
      shell: systemctl reset-failed jenkins || true
      changed_when: false

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Ensure Jenkins started
      service:
        name: jenkins
        state: started
        enabled: yes

    # ------------------------------------------------
    # Docker permissions
    # ------------------------------------------------
    - name: Ensure docker group exists
      group:
        name: docker
        state: present

    - name: Add Jenkins user to docker group
      user:
        name: jenkins
        groups: docker
        append: yes
      notify: restart jenkins

    - name: Wait for Docker socket
      wait_for:
        path: /var/run/docker.sock
        timeout: 30

    # ------------------------------------------------
    # Trivy Installation
    # ------------------------------------------------
    - name: Install Trivy GPG key
      shell: |
        curl -fsSL https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor -o {{ trivy_keyring }}
      args:
        creates: "{{ trivy_keyring }}"

    - name: Add Trivy repository
      apt_repository:
        repo: "deb [signed-by={{ trivy_keyring }}] https://aquasecurity.github.io/trivy-repo/deb {{ ansible_facts['distribution_release'] }} main"
        filename: trivy
        state: present
        update_cache: yes

    - name: Install Trivy
      apt:
        name: trivy
        state: present

    # ------------------------------------------------
    # Docker Volumes
    # ------------------------------------------------
    - name: Create Docker volumes
      community.docker.docker_volume:
        name: "{{ item }}"
      loop:
        - sonarqube_data
        - sonarqube_extensions
        - sonarqube_logs
        - nexus_data

    # ------------------------------------------------
    # SonarQube + Nexus
    # ------------------------------------------------
    - name: Deploy SonarQube
      community.docker.docker_container:
        name: sonarqube
        image: sonarqube:lts-community
        state: started
        restart_policy: always
        published_ports:
          - "9000:9000"
        volumes:
          - sonarqube_data:/opt/sonarqube/data
          - sonarqube_extensions:/opt/sonarqube/extensions
          - sonarqube_logs:/opt/sonarqube/logs

    - name: Deploy Nexus
      community.docker.docker_container:
        name: nexus
        image: sonatype/nexus3
        state: started
        restart_policy: always
        published_ports:
          - "8081:8081"
        volumes:
          - nexus_data:/nexus-data

# ==============================================================================
# LAYER 3: K8S MONITORING, LOGGING & GITOPS
# ==============================================================================

- name: Layer 3 - Monitoring, Logging & GitOps
  hosts: k8s_cluster1
  become: true

  vars:
    eks_region: us-east-1
    eks_cluster_name: subbu-cluster

  tasks:

    - name: Configure kubeconfig for EKS
      shell: |
        aws eks update-kubeconfig --region {{ eks_region }} --name {{ eks_cluster_name }}
      args:
        creates: "/home/{{ ansible_user }}/.kube/config"

    - name: Ensure Helm is installed
      shell: |
        if ! command -v helm >/dev/null; then
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      args:
        creates: /usr/local/bin/helm

    - name: Add Helm repos
      shell: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo add elastic https://helm.elastic.co
        helm repo update
      changed_when: false

    - name: Ensure monitoring namespace exists
      shell: kubectl get ns monitoring || kubectl create ns monitoring
      changed_when: false

    - name: Ensure logging namespace exists
      shell: kubectl get ns logging || kubectl create ns logging
      changed_when: false

    - name: Install Prometheus & Grafana
      shell: |
        helm upgrade --install kube-prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --set grafana.service.type=LoadBalancer \
          --set prometheus.service.type=LoadBalancer

    - name: Install Elasticsearch
      shell: |
        helm upgrade --install elasticsearch elastic/elasticsearch \
          --namespace logging \
          --set discovery.type=single-node \
          --set persistence.enabled=false

    - name: Install Kibana
      shell: |
        helm upgrade --install kibana elastic/kibana \
          --namespace logging \
          --set service.type=LoadBalancer

    - name: Install Logstash
      shell: |
        helm upgrade --install logstash elastic/logstash \
          --namespace logging \
          --set persistence.enabled=false

    - name: Install Filebeat
      shell: |
        helm upgrade --install filebeat elastic/filebeat \
          --namespace logging \
          --set daemonset.enabled=true \
          --set deployment.enabled=false

    - name: Install ArgoCD CLI
      get_url:
        url: https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        dest: /usr/local/bin/argocd
        mode: "0755"
